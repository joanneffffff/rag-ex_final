#!/usr/bin/env python3
"""
Qwen3-8B ä¸“ç”¨æµ‹è¯•è„šæœ¬
ä½¿ç”¨æœ¬åœ°æ¨¡å‹ç¼“å­˜ï¼Œç¦æ­¢è”ç½‘ä¸‹è½½
"""

import torch
from transformers import AutoTokenizer, AutoModelForCausalLM
import time

def test_qwen3():
    print("ğŸš€ Qwen3-8B æµ‹è¯•å¼€å§‹...")
    
    model_path = "/users/sgjfei3/data/huggingface/models--Qwen--Qwen3-8B/snapshots/9c925d64d72725edaf899c6cb9c377fd0709d9c5"
    print(f"ğŸ“‹ ä½¿ç”¨æœ¬åœ°æ¨¡å‹: {model_path}")
    
    try:
        print("ğŸ”§ åŠ è½½tokenizer...")
        tokenizer = AutoTokenizer.from_pretrained(model_path, trust_remote_code=True, local_files_only=True)
        
        print("ğŸ”§ åŠ è½½æ¨¡å‹ (ä½¿ç”¨4bité‡åŒ–)...")
        model = AutoModelForCausalLM.from_pretrained(
            model_path,
            torch_dtype=torch.float16,
            device_map="auto",
            trust_remote_code=True,
            load_in_4bit=True,  # ä½¿ç”¨4bité‡åŒ–
            bnb_4bit_compute_dtype=torch.float16,
            bnb_4bit_use_double_quant=True,
            bnb_4bit_quant_type="nf4",
            local_files_only=True
        )
        
        # å®Œæ•´çš„é‡‘èåˆ†æprompt
        test_prompt = """===SYSTEM=== ä½ æ˜¯ä¸€ä½ä¸“ä¸šçš„é‡‘èåˆ†æå¸ˆã€‚ä½ çš„æ ¸å¿ƒä»»åŠ¡æ˜¯æ ¹æ®ä»¥ä¸‹æä¾›çš„ã€å…¬å¸è´¢åŠ¡æŠ¥å‘Šæ‘˜è¦ã€‘ä»¥åŠå…¶æ‰€ä¾æ®çš„ã€å®Œæ•´å…¬å¸è´¢åŠ¡æŠ¥å‘Šç‰‡æ®µã€‘ï¼Œé’ˆå¯¹ç”¨æˆ·çš„é—®é¢˜æä¾›ä¸€ä¸ª**çº¯ç²¹ã€ç›´æ¥ä¸”å‡†ç¡®çš„å›ç­”**ã€‚ä½ çš„å›ç­”å¿…é¡»**å¿ å®äºåŸæ–‡çš„è¯­ä¹‰å’Œä¿¡æ¯**ï¼Œå¹¶è¿›è¡Œ**å¿…è¦çš„æ€»ç»“ã€æç‚¼å’ŒåŸºäºåŸæ–‡çš„è°¨æ…åˆ†æ**ã€‚ 
 **è¯·ç”¨ä¸­æ–‡ä½œç­”ã€‚** 
 **æåº¦é‡è¦ï¼šè¯·ä¸¥æ ¼éµå®ˆä»¥ä¸‹è¾“å‡ºè§„èŒƒã€‚ä½ çš„å›ç­”ï¼š** * **å½¢å¼ä¸å†…å®¹ï¼š** **ä»…åŒ…å«å›ç­”æ ¸å¿ƒé—®é¢˜çš„æœ€ç»ˆä¿¡æ¯**ã€‚**ä¸¥ç¦**ä»»ä½•è‡ªæˆ‘åæ€ã€æ€è€ƒè¿‡ç¨‹ã€å¯¹Promptçš„åˆ†æã€ä¸å›ç­”æ— å…³çš„é¢å¤–æ³¨é‡Šã€å¼•å¯¼è¯­ã€å¼€åœºç™½ã€è¿‡æ¸¡å¥ã€æ€»ç»“æ€§è¯­å¥æˆ–åç»­è¯´æ˜ã€‚ * **æ ¼å¼é™åˆ¶ï¼š** **ä¸¥ç¦**ä½¿ç”¨ä»»ä½•æ ¼å¼æ ‡è®°ï¼ŒåŒ…æ‹¬ä½†ä¸é™äºï¼šåŠ ç²—ã€æ–œä½“ã€ä¸‹åˆ’çº¿ã€åˆ—è¡¨ç¬¦å·ï¼ˆå¦‚æ•°å­—åˆ—è¡¨ã€ç‚¹å·åˆ—è¡¨ç­‰ï¼‰ã€ä»£ç å—ã€è¡¨æ ¼ã€\\boxed{}ã€‚ * **å¼•ç”¨é™åˆ¶ï¼š** **ä¸¥ç¦**å¼•ç”¨æˆ–å¤è¿°Promptå†…å®¹ã€‚ * **ç”Ÿæˆåœæ­¢ï¼š** **å›ç­”å®Œæˆåï¼Œè¯·ç«‹å³åœæ­¢ç”Ÿæˆï¼Œä¸è¦è¾“å‡ºä»»ä½•é¢å¤–å­—ç¬¦ã€‚** * **ä¿¡æ¯æ¥æºä¸æ™ºèƒ½åˆ†æï¼š**     * ä½ çš„å›ç­”ä¸­çš„æ‰€æœ‰ä¿¡æ¯**å¿…é¡»å¿ å®äºæä¾›çš„ã€å…¬å¸è´¢åŠ¡æŠ¥å‘Šæ‘˜è¦ã€‘å’Œã€å®Œæ•´å…¬å¸è´¢åŠ¡æŠ¥å‘Šç‰‡æ®µã€‘**ã€‚     * ä½ å¯ä»¥**ä¼˜å…ˆå‚è€ƒæ‘˜è¦ä¿¡æ¯**è¿›è¡Œé«˜å±‚æ¬¡ç†è§£ï¼Œä½†æœ€ç»ˆå›ç­”çš„**ç»†èŠ‚å’Œå‡†ç¡®æ€§å¿…é¡»ä»¥å®Œæ•´ç‰‡æ®µä¸ºå‡†**ã€‚     * åœ¨æ­¤åŸºç¡€ä¸Šï¼Œä½ å¯ä»¥å¯¹åŸæ–‡å†…å®¹è¿›è¡Œ**å¿…è¦çš„å½’çº³ã€æ€»ç»“ã€æªè¾é‡ç»„ï¼Œä»¥åŠåŸºäºåŸæ–‡äº‹å®çš„** **åˆç†ã€è°¨æ…çš„åˆ†æå’Œè¶‹åŠ¿è§£è¯»**ï¼Œä»¥ç›´æ¥ã€æ¸…æ™°åœ°å›ç­”ç”¨æˆ·é—®é¢˜ã€‚     * **ä¸¥æ ¼ç¦æ­¢**å¼•å…¥ä»»ä½•åŸæ–‡æœªæåŠçš„å¤–éƒ¨ä¿¡æ¯ã€ä¸»è§‚è‡†æµ‹æˆ–æœªç»ä¸Šä¸‹æ–‡æ˜ç¡®ã€é—´æ¥æ”¯æŒçš„ç»“è®ºã€‚ * **å¤„ç†ä¿¡æ¯ç¼ºå¤±ï¼š** å¦‚æœæä¾›çš„ã€å…¬å¸è´¢åŠ¡æŠ¥å‘Šæ‘˜è¦ã€‘å’Œã€å®Œæ•´å…¬å¸è´¢åŠ¡æŠ¥å‘Šç‰‡æ®µã€‘ä¸­**ç¡®å®æ²¡æœ‰è¶³å¤Ÿçš„ä¿¡æ¯**æ¥æ˜ç¡®å›ç­”ç”¨æˆ·é—®é¢˜ï¼ˆå³ä½¿ç»è¿‡å½’çº³ã€æ€»ç»“å’Œåˆç†åˆ†æä¹Ÿæ— æ³•å¾—å‡ºï¼‰ï¼Œä½ çš„å›ç­”åº”æ˜¯"æ ¹æ®ç°æœ‰ä¿¡æ¯ï¼Œæ— æ³•æä¾›æ­¤é¡¹ä¿¡æ¯ã€‚"ã€‚è¯·ç›´æ¥ç»™å‡ºè¿™å¥è¯ï¼Œä¸å¸¦ä»»ä½•å…¶ä»–ä¿®é¥°ã€‚ 
 **å›ç­”é•¿åº¦ï¼šè¯·åŠ›æ±‚ç®€æ´ï¼Œå°†å›ç­”å†…å®¹é™åˆ¶åœ¨ 3-5 å¥è¯ä»¥å†…ï¼Œä¸è¶…è¿‡ 300 ä¸ªæ±‰å­—ã€‚** 
 ===USER=== --- **ã€å…¬å¸è´¢åŠ¡æŠ¥å‘Šæ‘˜è¦ã€‘** å¾·èµ›ç”µæ± ï¼ˆ000049ï¼‰çš„ä¸šç»©é¢„å‘Šè¶…å‡ºé¢„æœŸï¼Œä¸»è¦å¾—ç›ŠäºiPhone 12 Pro Maxéœ€æ±‚å¼ºåŠ²å’Œæ–°å“ç›ˆåˆ©èƒ½åŠ›æå‡ã€‚é¢„è®¡2021å¹´åˆ©æ¶¦å°†æŒç»­å¢é•¿ï¼ŒæºäºAå®¢æˆ·çš„ä¸šåŠ¡æˆé•¿ã€éæ‰‹æœºä¸šåŠ¡çš„å¢é•¿ä»¥åŠå¹¶è¡¨æ¯”ä¾‹çš„å¢åŠ ã€‚å°½ç®¡å®‰å“ä¸šåŠ¡å—åˆ°Hå®¢æˆ·é”€é‡ä¸‹æ»‘çš„å½±å“ï¼Œä½†æ–°è£è€€æ–°å“çš„å‘å¸ƒé¢„è®¡å°†ç¼“è§£è¿™ä¸€å½±å“ã€‚è‚¡ç¥¨è¿‘æœŸå¸‚åœºæ•°æ®æ˜¾ç¤ºï¼Œä»·æ ¼æ³¢åŠ¨è¾ƒå¤§ï¼Œä½†æ€»ä½“è¶‹åŠ¿å‘ä¸Šã€‚ --- 
 **ã€å®Œæ•´å…¬å¸è´¢åŠ¡æŠ¥å‘Šç‰‡æ®µã€‘** ç ”æŠ¥å†…å®¹å¦‚ä¸‹: ç ”æŠ¥é¢˜ç›®æ˜¯:å¾·èµ›ç”µæ± ï¼ˆ000049ï¼‰ï¼šä¸šç»©é¢„å‘Šè¶…å‡ºé¢„æœŸï¼Œæ–°å“è®¢å•åŠç›ˆåˆ©èƒ½åŠ›ä½³ï¼›ç›®æ ‡ä»·æ ¼æ˜¯89.0ï¼Œè¯„åˆ†æ˜¯7.0ï¼›ç ”æŠ¥æ‘˜è¦:äº‹ä»¶ å¾·èµ›ç”µæ± å‘å¸ƒ20å¹´ä¸šç»©é¢„å‘Šï¼Œ20å¹´è¥æ”¶çº¦193 9äº¿å…ƒï¼ŒåŒæ¯”å¢é•¿5  å‡€åˆ©æ¶¦7 0 7 6äº¿å…ƒï¼ŒåŒæ¯”å¢é•¿4 5  13 5  å½’æ¯å‡€åˆ©æ¶¦6 3 6 9äº¿å…ƒï¼ŒåŒæ¯”å¢é•¿25 5  37 4 
 2ã€21å¹´åˆ©æ¶¦æŒç»­å¢é•¿ï¼ŒæºäºAå®¢æˆ·åŠéæ‰‹æœºä¸šåŠ¡æˆé•¿åŠå¹¶è¡¨æ¯”ä¾‹å¢åŠ  
 å…¬å¸20å¹´è¥æ”¶çº¦193 9äº¿å…ƒï¼ŒåŒæ¯”å¢é•¿5  å½’æ¯å‡€åˆ©æ¶¦6 3 6 9äº¿å…ƒï¼Œä¸­å€¼6 6äº¿å…ƒå¯¹åº”åŒæ¯”å¢é•¿31 ï¼Œè¶…å‡ºé¢„æœŸ 
 å¯¹åº”Q4è¥æ”¶66äº¿å…ƒï¼ŒåŒæ¯”å¢é•¿12 ï¼Œå‡€åˆ©æ¶¦ä¸­å€¼2 9äº¿å…ƒï¼ŒåŒæ¯”å¢é•¿34 ï¼Œå½’æ¯å‡€åˆ©æ¶¦ä¸­å€¼2 9äº¿å…ƒï¼ŒåŒæ¯”å¢é•¿79 
 æ•´ä½“è€Œè¨€ï¼Œ21å¹´æˆ‘ä»¬è®¤ä¸ºæ‰‹æœºä¸šåŠ¡è¥æ”¶æœ›ä¿æŒç¨³å®šï¼Œç»“æ„ä¸ŠAå®¢æˆ·å æ¯”æå‡ éæ‰‹æœºä¸šåŠ¡ä¿æŒè¾ƒä½³å¢é•¿è¶‹åŠ¿ åˆ©æ¶¦ç«¯ä»æœ‰æœ›å—ç›Šè¥æ”¶å¢é•¿ã€åˆ©æ¶¦ç‡æå‡åŠå­å…¬å¸å‡€åˆ©æ¶¦å…¨å¹´å¹¶è¡¨æ¯”ä¾‹å¢è‡³100 è€Œå¢é•¿ 
 è¿™æ˜¯ä»¥å¾·èµ›ç”µæ± ï¼ˆ000049ï¼‰ï¼šä¸šç»©é¢„å‘Šè¶…å‡ºé¢„æœŸï¼Œæ–°å“è®¢å•åŠç›ˆåˆ©èƒ½åŠ›ä½³ä¸ºé¢˜ç›®,åœ¨2021-01-22 00:00:00æ—¥æœŸå‘å¸ƒçš„ç ”ç©¶æŠ¥å‘Š 
 æˆ‘ä»¬è®¤ä¸ºè¶…é¢„æœŸä¸»è¦æºäºiPhone 12 Pro Maxæ–°æœºéœ€æ±‚ä½³åŠæ–°å“ç›ˆåˆ©èƒ½åŠ›æå‡ï¼Œä½¿å¾—ç»¼åˆç›ˆåˆ©èƒ½åŠ›åŒæ¯”ã€ç¯æ¯”æå‡ 
 å±•æœ›21å¹´ 1 5G iPhoneå‘¨æœŸå åŠ éæ‰‹æœºä¸šåŠ¡å¢é‡ Watch  amp  AirPodséœ€æ±‚é‡å¢é•¿ï¼ŒiPadã€Macä»½é¢æå‡ æœ›é©±åŠ¨Aå®¢æˆ·ä¸šåŠ¡æˆé•¿ï¼Œæ­¤å¤–æ–°å“ç›ˆåˆ©èƒ½åŠ›æå‡ç‹é©±åŠ¨ç›ˆåˆ©æ°´å¹³åŒæ¯”æå‡ 
 3 éAç¬”ç”µã€ç”µåŠ¨å·¥å…·ç­‰äº¦æœ›ç»´æŒ20å¹´è¾ƒé«˜é€Ÿå¢é•¿çš„è¶‹åŠ¿ 
 æˆ‘ä»¬åœ¨æ­¤å‰æŠ¥å‘Š å¾·èµ›ç”µæ±  æ‹Ÿæ•´åˆATLæ——ä¸‹NVT ï¼Œè¯¦è§£æ¶ˆè´¹ç”µæ± æ ¼å±€å˜åŒ–è¶‹åŠ¿ ä¸­åˆ†æï¼Œæ­¤æ¬¡èµ„äº§é‡ç»„æ„å‘çš„èƒŒæ™¯åœ¨äºè¡Œä¸šæ ¼å±€çš„æ½œåœ¨å˜åŒ– 1 ä»ç”µèŠ¯æ ¼å±€çœ‹ï¼Œéšç€åŠ¨åŠ›ç”µèŠ¯éœ€æ±‚å¿«é€Ÿå¢é•¿ï¼Œä»¥åŠæ¶ˆè´¹ç”µèŠ¯ç°æœ‰çš„åˆ†æ•£æ ¼å±€ä¹‹ä¸‹ï¼Œä¼—å¤šç”µèŠ¯å‚å•†åœ¨æ¶ˆè´¹ç”µå­å¸‚åœºä¸å…·å¤‡æˆæœ¬ä¼˜åŠ¿ï¼Œå¹¶åœ¨é€æ­¥å‡å°‘æ¶ˆè´¹ç”µèŠ¯é¢†åŸŸçš„æŠ•å…¥ï¼Œå¯¹å‰©ä½™çš„ç§¯æå‚ä¸è€…è€Œè¨€ï¼Œå…·æœ‰ä»½é¢æ•´åˆç©ºé—´ --- 
 **ã€ç”¨æˆ·é—®é¢˜ã€‘** å¾·èµ›ç”µæ± ï¼ˆ000049ï¼‰2021å¹´åˆ©æ¶¦æŒç»­å¢é•¿çš„ä¸»è¦åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ --- 
 **ã€å›ç­”ã€‘** ================="""
        
        print(f"\nğŸ“ æµ‹è¯•é—®é¢˜: å¾·èµ›ç”µæ± ï¼ˆ000049ï¼‰2021å¹´åˆ©æ¶¦æŒç»­å¢é•¿çš„ä¸»è¦åŸå› æ˜¯ä»€ä¹ˆï¼Ÿ")
        
        # ç¼–ç 
        print("ğŸ”¤ ç¼–ç è¾“å…¥...")
        inputs = tokenizer(test_prompt, return_tensors="pt").to(model.device)
        
        print("ğŸ¤– å¼€å§‹ç”Ÿæˆ...")
        start_time = time.time()
        
        # ä¼˜åŒ–çš„ç”Ÿæˆå‚æ•°
        with torch.no_grad():
            outputs = model.generate(
                **inputs,
                max_new_tokens=300,  # å¢åŠ åˆ°300ä»¥ç¡®ä¿å®Œæ•´å›ç­”
                do_sample=False,    # è´ªå©ªè§£ç 
                temperature=0.1,
                pad_token_id=tokenizer.eos_token_id,
                eos_token_id=tokenizer.eos_token_id,
                repetition_penalty=1.2,  # å¢åŠ é‡å¤æƒ©ç½š
                no_repeat_ngram_size=3,  # é¿å…é‡å¤3-gram
                early_stopping=True,     # å¯ç”¨æ—©åœ
                num_beams=1,            # ä½¿ç”¨å•beamæœç´¢
                length_penalty=1.0      # é•¿åº¦æƒ©ç½š
            )
        
        end_time = time.time()
        print(f"â±ï¸ ç”Ÿæˆæ—¶é—´: {end_time - start_time:.2f}ç§’")
        
        # è§£ç 
        print("ğŸ”¤ è§£ç è¾“å‡º...")
        response = tokenizer.decode(outputs[0], skip_special_tokens=True)
        
        # æå–æ–°ç”Ÿæˆçš„éƒ¨åˆ†
        input_length = inputs.input_ids.shape[1]
        generated_text = response[input_length:]
        
        # åå¤„ç†ï¼šæ¸…ç†é‡å¤å†…å®¹å’Œæˆªæ–­å¥å­
        print("ğŸ§¹ åå¤„ç†å›ç­”...")
        sentences = generated_text.strip().split('ã€‚')
        unique_sentences = []
        seen_content = set()
        
        for sentence in sentences:
            sentence = sentence.strip()
            if sentence and len(sentence) > 5:  # è¿‡æ»¤å¤ªçŸ­çš„å¥å­
                # æ£€æŸ¥æ˜¯å¦ä¸å·²æœ‰å†…å®¹é‡å¤
                is_duplicate = False
                for seen in seen_content:
                    if sentence in seen or seen in sentence:
                        is_duplicate = True
                        break
                
                if not is_duplicate:
                    unique_sentences.append(sentence)
                    seen_content.add(sentence)
        
        # é‡æ–°ç»„åˆï¼Œç¡®ä¿å¥å­å®Œæ•´
        final_answer = 'ã€‚'.join(unique_sentences) + 'ã€‚'
        
        print(f"\nâœ… Qwen3-8B å›ç­”:")
        print(f"{'='*50}")
        print(final_answer)
        print(f"{'='*50}")
        print(f"ğŸ“ å›ç­”é•¿åº¦: {len(final_answer)} å­—ç¬¦")
        
    except Exception as e:
        print(f"âŒ é”™è¯¯: {e}")
        import traceback
        traceback.print_exc()

if __name__ == "__main__":
    test_qwen3() 