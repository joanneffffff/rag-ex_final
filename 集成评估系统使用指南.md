# é›†æˆè¯„ä¼°ç³»ç»Ÿä½¿ç”¨æŒ‡å—

## ğŸ¯ ç³»ç»Ÿæ¦‚è¿°

é›†æˆè¯„ä¼°ç³»ç»Ÿæ˜¯ä¸€ä¸ªç»Ÿä¸€çš„RAGç³»ç»Ÿè¯„ä¼°å¹³å°ï¼Œæ•´åˆäº†æ‰€æœ‰æ£€ç´¢å’Œé‡æ’åºæ¨¡å—ï¼Œæ”¯æŒå¤šç§å¯¹æ¯”å®éªŒã€‚**æœ€æ–°ç‰ˆæœ¬å·²å‡çº§ä¸ºä½¿ç”¨çœŸå®RAGç³»ç»Ÿç»„ä»¶ï¼Œç¡®ä¿è¯„ä¼°é€»è¾‘ä¸ç”Ÿäº§ç³»ç»Ÿå®Œå…¨ä¸€è‡´ã€‚**

## ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½

### ğŸ” æ”¯æŒçš„è¯„ä¼°æ–¹æ³•

| æ–¹æ³• | æè¿° | é€‚ç”¨åœºæ™¯ |
|------|------|----------|
| `encoder_only` | ä»…ä½¿ç”¨ç¼–ç å™¨æ£€ç´¢ | åŸºç¡€æ£€ç´¢æµ‹è¯• |
| `encoder_faiss` | ç¼–ç å™¨+FAISSåŠ é€Ÿ | å¤§è§„æ¨¡æ£€ç´¢ |
| `encoder_reranker` | ç¼–ç å™¨+é‡æ’åº | é«˜ç²¾åº¦æ£€ç´¢ |
| `encoder_faiss_reranker` | ç¼–ç å™¨+FAISS+é‡æ’åº | å®Œæ•´æµç¨‹ |

### ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
é›†æˆè¯„ä¼°ç³»ç»Ÿ (çœŸå®RAGç»„ä»¶ç‰ˆ)
â”œâ”€â”€ æ•°æ®åŠ è½½æ¨¡å—
â”‚   â”œâ”€â”€ è¯„ä¼°æ•°æ®åŠ è½½
â”‚   â”œâ”€â”€ æ£€ç´¢åº“æ„å»º (DocumentWithMetadata)
â”‚   â””â”€â”€ å…ƒæ•°æ®æå–
â”œâ”€â”€ RAGç³»ç»Ÿç®¡ç†å™¨
â”‚   â”œâ”€â”€ FinbertEncoder (åŒè¯­è¨€)
â”‚   â”œâ”€â”€ BilingualRetriever
â”‚   â”œâ”€â”€ QwenReranker
â”‚   â””â”€â”€ FAISSç´¢å¼• (å¯é€‰)
â”œâ”€â”€ æ£€ç´¢å¼•æ“æ¨¡å—
â”‚   â”œâ”€â”€ è¯­ä¹‰æ£€ç´¢ (BilingualRetriever)
â”‚   â”œâ”€â”€ é‡æ’åº (QwenReranker)
â”‚   â””â”€â”€ è¯­è¨€æ£€æµ‹
â””â”€â”€ è¯„ä¼°åˆ†ææ¨¡å—
    â”œâ”€â”€ MRRè®¡ç®—
    â”œâ”€â”€ æ€§èƒ½ç»Ÿè®¡
    â””â”€â”€ å¯¹æ¯”æŠ¥å‘Š
```

### âœ¨ ç‰¹è‰²åŠŸèƒ½

**âœ… å…ƒæ•°æ®è¿‡æ»¤**
- æ”¯æŒAlphaFinå…¬å¸åç§°ã€è‚¡ç¥¨ä»£ç ã€æŠ¥å‘Šæ—¥æœŸè¿‡æ»¤
- æé«˜æ£€ç´¢ç²¾åº¦å’Œç›¸å…³æ€§

**âœ… çœŸå®RAGç»„ä»¶**
- ä½¿ç”¨FinbertEncoderã€BilingualRetrieverã€QwenReranker
- ä¸ç”Ÿäº§ç³»ç»Ÿå®Œå…¨ä¸€è‡´çš„è¯„ä¼°é€»è¾‘

**âœ… å¤šè¯­è¨€æ”¯æŒ**
- æ”¯æŒä¸­è‹±æ–‡æ··åˆæ£€ç´¢å’Œè¯„ä¼°
- è‡ªåŠ¨è¯­è¨€æ£€æµ‹å’Œè·¯ç”±

**âœ… å¤šç§æ¨¡å‹æ”¯æŒ**
- çµæ´»çš„ç¼–ç å™¨å’Œé‡æ’åºæ¨¡å‹é…ç½®
- æ”¯æŒä¸åŒæ¨¡å‹å¯¹æ¯”å®éªŒ

**âœ… æ€§èƒ½ç›‘æ§**
- æ£€ç´¢å’Œé‡æ’åºæ—¶é—´ç»Ÿè®¡
- è¯¦ç»†çš„æ€§èƒ½åˆ†ææŠ¥å‘Š

**âœ… ä¸€é”®å¯¹æ¯”**
- è‡ªåŠ¨è¿è¡Œå¤šç§æ–¹æ³•å¯¹æ¯”
- ç”Ÿæˆè¯¦ç»†çš„å¯¹æ¯”æŠ¥å‘Š

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºç¡€ä½¿ç”¨

```bash
# å¿«é€Ÿæµ‹è¯• (50ä¸ªæ ·æœ¬)
python encoder_finetune_evaluate/integrated_evaluation_system.py \
    --eval_data evaluate_mrr/alphafin_eval.jsonl \
    --max_samples 50 \
    --method encoder_only
```

### 2. å®Œæ•´å¯¹æ¯”å®éªŒ

```bash
# è¿è¡Œæ‰€æœ‰æ–¹æ³•å¯¹æ¯”
python encoder_finetune_evaluate/integrated_evaluation_system.py \
    --eval_data evaluate_mrr/alphafin_eval.jsonl \
    --max_samples 100 \
    --method all
```

### 3. å¯ç”¨å…ƒæ•°æ®è¿‡æ»¤

```bash
# ä½¿ç”¨å…ƒæ•°æ®è¿‡æ»¤æé«˜ç²¾åº¦
python encoder_finetune_evaluate/integrated_evaluation_system.py \
    --eval_data evaluate_mrr/alphafin_eval.jsonl \
    --max_samples 500 \
    --method all \
    --use_metadata_filter
```

## ğŸ“Š å‚æ•°è¯´æ˜

### ğŸ”§ åŸºç¡€å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--eval_data` | str | `evaluate_mrr/alphafin_eval.jsonl` | è¯„ä¼°æ•°æ®æ–‡ä»¶è·¯å¾„ |
| `--corpus_data` | str | `data/alphafin/alphafin_merged_generated_qa_full_dedup.json` | æ£€ç´¢åº“æ•°æ®æ–‡ä»¶ |
| `--encoder_model` | str | `models/finetuned_finbert_tatqa` | ç¼–ç å™¨æ¨¡å‹åç§° |
| `--reranker_model` | str | `Qwen/Qwen3-Reranker-0.6B` | é‡æ’åºæ¨¡å‹åç§° |
| `--method` | str | `all` | è¯„ä¼°æ–¹æ³•é€‰æ‹© |

### ğŸ›ï¸ æ€§èƒ½å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--top_k_retrieval` | int | 100 | æ£€ç´¢è¿”å›çš„top-kæ–‡æ¡£æ•° |
| `--top_k_rerank` | int | 10 | é‡æ’åºçš„top-kæ–‡æ¡£æ•° |
| `--max_samples` | int | 100 | æœ€å¤§è¯„ä¼°æ ·æœ¬æ•° |
| `--batch_size` | int | 4 | æ‰¹æ¬¡å¤§å° |
| `--max_length` | int | 512 | åºåˆ—æœ€å¤§é•¿åº¦ |

### ğŸ” é«˜çº§å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--use_metadata_filter` | flag | False | æ˜¯å¦å¯ç”¨å…ƒæ•°æ®è¿‡æ»¤ |
| `--device` | str | `cuda` | è®¾å¤‡é€‰æ‹© (cuda/cpu) |
| `--num_gpus` | int | 2 | ä½¿ç”¨çš„GPUæ•°é‡ |

## ğŸ“ˆ ä½¿ç”¨åœºæ™¯

### ğŸ§ª å¿«é€ŸéªŒè¯

**ç›®æ ‡**: éªŒè¯ç³»ç»Ÿæ˜¯å¦æ­£å¸¸å·¥ä½œ
```bash
python encoder_finetune_evaluate/integrated_evaluation_system.py \
    --eval_data evaluate_mrr/alphafin_eval.jsonl \
    --max_samples 50 \
    --method encoder_only \
    --batch_size 1
```

### ğŸ“Š æ€§èƒ½å¯¹æ¯”

**ç›®æ ‡**: æ¯”è¾ƒä¸åŒæ–¹æ³•çš„æ€§èƒ½
```bash
python encoder_finetune_evaluate/integrated_evaluation_system.py \
    --eval_data evaluate_mrr/alphafin_eval.jsonl \
    --max_samples 500 \
    --method all \
    --use_metadata_filter
```

### ğŸ¯ ç”Ÿäº§è¯„ä¼°

**ç›®æ ‡**: å…¨é¢è¯„ä¼°ç³»ç»Ÿæ€§èƒ½
```bash
python encoder_finetune_evaluate/integrated_evaluation_system.py \
    --eval_data evaluate_mrr/alphafin_eval.jsonl \
    --max_samples 1000 \
    --method encoder_faiss_reranker \
    --use_metadata_filter \
    --top_k_retrieval 200 \
    --top_k_rerank 20
```

## ğŸ“Š è¾“å‡ºç»“æœ

### ğŸ“‹ æ§åˆ¶å°è¾“å‡º

```
ğŸš€ é›†æˆè¯„ä¼°ç³»ç»Ÿ - ä½¿ç”¨çœŸå®RAGç³»ç»Ÿç»„ä»¶
ğŸ“Š é…ç½®:
  - è¯„ä¼°æ•°æ®: evaluate_mrr/alphafin_eval.jsonl
  - æ£€ç´¢åº“æ•°æ®: data/alphafin/alphafin_merged_generated_qa_full_dedup.json
  - ç¼–ç å™¨æ¨¡å‹: models/finetuned_finbert_tatqa
  - é‡æ’åºæ¨¡å‹: Qwen/Qwen3-Reranker-0.6B
  - è¯„ä¼°æ–¹æ³•: all
  - æœ€å¤§æ ·æœ¬æ•°: 100
  - å…ƒæ•°æ®è¿‡æ»¤: å¯ç”¨
  - GPUæ•°é‡: 2

ğŸ”¬ å¼€å§‹å¯¹æ¯”å®éªŒ
============================================================

ğŸ“Š æµ‹è¯•æ–¹æ³•: encoder_only
----------------------------------------
ğŸ“ˆ ç»“æœ:
  - æ£€ç´¢MRR @100: 0.2345
  - é‡æ’åºMRR @10: 0.0000
  - å¹³å‡æ£€ç´¢æ—¶é—´: 0.045s
  - å¹³å‡é‡æ’åºæ—¶é—´: 0.000s
  - æœ‰æ•ˆæŸ¥è¯¢æ•°: 95/100

ğŸ“Š æµ‹è¯•æ–¹æ³•: encoder_faiss
----------------------------------------
ğŸ“ˆ ç»“æœ:
  - æ£€ç´¢MRR @100: 0.2345
  - é‡æ’åºMRR @10: 0.0000
  - å¹³å‡æ£€ç´¢æ—¶é—´: 0.023s
  - å¹³å‡é‡æ’åºæ—¶é—´: 0.000s
  - æœ‰æ•ˆæŸ¥è¯¢æ•°: 95/100

ğŸ“Š æµ‹è¯•æ–¹æ³•: encoder_reranker
----------------------------------------
ğŸ“ˆ ç»“æœ:
  - æ£€ç´¢MRR @100: 0.2345
  - é‡æ’åºMRR @10: 0.3456
  - å¹³å‡æ£€ç´¢æ—¶é—´: 0.045s
  - å¹³å‡é‡æ’åºæ—¶é—´: 0.123s
  - æœ‰æ•ˆæŸ¥è¯¢æ•°: 95/100

ğŸ“Š æµ‹è¯•æ–¹æ³•: encoder_faiss_reranker
----------------------------------------
ğŸ“ˆ ç»“æœ:
  - æ£€ç´¢MRR @100: 0.2345
  - é‡æ’åºMRR @10: 0.3456
  - å¹³å‡æ£€ç´¢æ—¶é—´: 0.023s
  - å¹³å‡é‡æ’åºæ—¶é—´: 0.123s
  - æœ‰æ•ˆæŸ¥è¯¢æ•°: 95/100

============================================================
ğŸ“Š å¯¹æ¯”å®éªŒæ€»ç»“
============================================================
æ–¹æ³•                     æ£€ç´¢MRR    é‡æ’åºMRR    æ£€ç´¢æ—¶é—´    é‡æ’åºæ—¶é—´
------------------------------------------------------------------------
encoder_faiss_reranker   0.2345     0.3456      0.023      0.123
encoder_reranker         0.2345     0.3456      0.045      0.123
encoder_faiss            0.2345     0.0000      0.023      0.000
encoder_only             0.2345     0.0000      0.045      0.000

ğŸ† æœ€ä½³æ£€ç´¢æ–¹æ³•: encoder_faiss_reranker (MRR: 0.2345)
ğŸ† æœ€ä½³é‡æ’åºæ–¹æ³•: encoder_faiss_reranker (MRR: 0.3456)

ğŸ‰ è¯„ä¼°å®Œæˆï¼
```

### ğŸ“„ è¯¦ç»†æŠ¥å‘Š

ç³»ç»Ÿä¼šè‡ªåŠ¨ç”Ÿæˆè¯¦ç»†çš„è¯„ä¼°æŠ¥å‘Šï¼ŒåŒ…å«ï¼š
- æ¯ç§æ–¹æ³•çš„è¯¦ç»†æŒ‡æ ‡
- æ€§èƒ½å¯¹æ¯”åˆ†æ
- æœ€ä½³æ–¹æ³•æ¨è
- é”™è¯¯åˆ†æ

## ğŸ”§ æ•…éšœæ’é™¤

### ğŸš¨ å¸¸è§é—®é¢˜

**1. GPUå†…å­˜ä¸è¶³**
```bash
# è§£å†³æ–¹æ¡ˆï¼šä½¿ç”¨CPUæˆ–å‡å°‘æ‰¹æ¬¡å¤§å°
python encoder_finetune_evaluate/integrated_evaluation_system.py \
    --eval_data evaluate_mrr/alphafin_eval.jsonl \
    --device cpu \
    --batch_size 1
```

**2. æ¨¡å‹åŠ è½½å¤±è´¥**
```bash
# è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥æ¨¡å‹åç§°å’Œç½‘ç»œè¿æ¥
python encoder_finetune_evaluate/integrated_evaluation_system.py \
    --eval_data evaluate_mrr/alphafin_eval.jsonl \
    --encoder_model "models/finetuned_finbert_tatqa" \
    --reranker_model "Qwen/Qwen3-Reranker-0.6B"
```

**3. æ•°æ®æ–‡ä»¶ä¸å­˜åœ¨**
```bash
# è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥æ–‡ä»¶è·¯å¾„
ls -la evaluate_mrr/alphafin_eval.jsonl
ls -la data/alphafin/alphafin_merged_generated_qa_full_dedup.json
```

### ğŸ” è°ƒè¯•æ¨¡å¼

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—
python encoder_finetune_evaluate/integrated_evaluation_system.py \
    --eval_data evaluate_mrr/alphafin_eval.jsonl \
    --max_samples 10 \
    --method encoder_only \
    --batch_size 1
```

## ğŸ“š æœ€ä½³å®è·µ

### ğŸ¯ è¯„ä¼°æµç¨‹å»ºè®®

1. **å¿«é€ŸéªŒè¯** (50ä¸ªæ ·æœ¬)
   - éªŒè¯ç³»ç»Ÿé…ç½®æ­£ç¡®
   - æ£€æŸ¥æ•°æ®åŠ è½½æ­£å¸¸
   - ç¡®è®¤RAGç»„ä»¶æ­£å¸¸å·¥ä½œ

2. **æ–¹æ³•å¯¹æ¯”** (500ä¸ªæ ·æœ¬)
   - æ¯”è¾ƒä¸åŒæ–¹æ³•æ€§èƒ½
   - ç¡®å®šæœ€ä½³æ–¹æ³•ç»„åˆ
   - éªŒè¯å¤šè¯­è¨€æ”¯æŒ

3. **ç”Ÿäº§è¯„ä¼°** (1000+æ ·æœ¬)
   - å…¨é¢è¯„ä¼°ç³»ç»Ÿæ€§èƒ½
   - ç”Ÿæˆæœ€ç»ˆæŠ¥å‘Š
   - ä¸çœŸå®RAGç³»ç»Ÿæ€§èƒ½å¯¹æ¯”

### âš¡ æ€§èƒ½ä¼˜åŒ–

1. **æ‰¹æ¬¡å¤§å°è°ƒä¼˜**
   - ä»batch_size=1å¼€å§‹
   - é€æ­¥å¢åŠ åˆ°æœ€ä¼˜å€¼

2. **æ¨¡å‹é€‰æ‹©**
   - æ ¹æ®æ•°æ®ç‰¹ç‚¹é€‰æ‹©åˆé€‚æ¨¡å‹
   - å¹³è¡¡æ€§èƒ½å’Œé€Ÿåº¦
   - ä¼˜å…ˆä½¿ç”¨å¾®è°ƒåçš„Finbertæ¨¡å‹

3. **å‚æ•°è°ƒä¼˜**
   - è°ƒæ•´top_k_retrievalå’Œtop_k_rerank
   - æ ¹æ®å®é™…éœ€æ±‚ä¼˜åŒ–
   - åˆ©ç”¨FAISSåŠ é€Ÿå¤§è§„æ¨¡æ£€ç´¢

4. **å¤šGPUä¼˜åŒ–**
   - åˆç†è®¾ç½®GPUæ•°é‡
   - ç›‘æ§GPUå†…å­˜ä½¿ç”¨
   - é¿å…å†…å­˜æº¢å‡º

### ğŸ”’ æ•°æ®å®‰å…¨

1. **æ•°æ®æ³„éœ²æ£€æŸ¥**
   - ç¡®ä¿è®­ç»ƒé›†å’Œè¯„ä¼°é›†åˆ†ç¦»
   - é¿å…æ•°æ®æ±¡æŸ“
   - éªŒè¯DocumentWithMetadataç»“æ„æ­£ç¡®

2. **ç»“æœéªŒè¯**
   - æ£€æŸ¥è¯„ä¼°ç»“æœåˆç†æ€§
   - éªŒè¯æŒ‡æ ‡è®¡ç®—æ­£ç¡®
   - ç¡®è®¤ä¸çœŸå®RAGç³»ç»Ÿç»“æœä¸€è‡´

3. **ç»„ä»¶éªŒè¯**
   - éªŒè¯BilingualRetrieveræ£€ç´¢é€»è¾‘
   - ç¡®è®¤QwenRerankeré‡æ’åºæ•ˆæœ
   - æ£€æŸ¥å¤šè¯­è¨€æ”¯æŒæ­£å¸¸

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š
1. æ£€æŸ¥å‚æ•°é…ç½®
2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—
3. å°è¯•ç®€åŒ–é…ç½®
4. è”ç³»æŠ€æœ¯æ”¯æŒ

## ğŸ”„ ç‰ˆæœ¬æ›´æ–°è¯´æ˜

### v2.0 - çœŸå®RAGç»„ä»¶é›†æˆ (æœ€æ–°)

**ä¸»è¦æ”¹è¿›**:
- âœ… ä½¿ç”¨FinbertEncoderã€BilingualRetrieverã€QwenRerankerçœŸå®ç»„ä»¶
- âœ… æ”¯æŒä¸­è‹±æ–‡æ··åˆæ£€ç´¢å’Œè¯„ä¼°
- âœ… è‡ªåŠ¨è¯­è¨€æ£€æµ‹å’Œè·¯ç”±
- âœ… å¤šGPUå¹¶è¡Œå¤„ç†æ”¯æŒ
- âœ… ä¸ç”Ÿäº§ç³»ç»Ÿå®Œå…¨ä¸€è‡´çš„è¯„ä¼°é€»è¾‘

**å‘åå…¼å®¹æ€§**: ä¿æŒåŸæœ‰APIæ¥å£ä¸å˜ï¼Œå†…éƒ¨å®ç°å®Œå…¨å‡çº§

---

**æ³¨æ„**: å»ºè®®ä»æœ€å°é…ç½®å¼€å§‹æµ‹è¯•ï¼Œé€æ­¥å¢åŠ å¤æ‚åº¦ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œã€‚æ–°ç‰ˆæœ¬ä½¿ç”¨çœŸå®RAGç»„ä»¶ï¼Œè¯„ä¼°ç»“æœæ›´å‡†ç¡®å¯é ã€‚ 