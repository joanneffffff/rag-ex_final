# åŸå§‹è¯„ä¼°è„šæœ¬ä½¿ç”¨æŒ‡å—

## ğŸ¯ è„šæœ¬æ¦‚è¿°

**è„šæœ¬åç§°**: `evaluate_encoder_reranker_mrr_rag_system_multi_gpu_fixed.py`  
**ç”¨é€”**: é€šç”¨RAGç³»ç»Ÿè¯„ä¼°  
**ç‰¹ç‚¹**: ä½¿ç”¨çœŸå®RAGç³»ç»Ÿç»„ä»¶ï¼Œæ”¯æŒä¸­è‹±æ–‡æ··åˆæ£€ç´¢  
**é€‚ç”¨**: TAT-QAã€AlphaFinç­‰é€šç”¨æ•°æ®  
**ç‰ˆæœ¬**: v2.0 - çœŸå®RAGç»„ä»¶é›†æˆç‰ˆ  

## ğŸ“‹ æ ¸å¿ƒåŠŸèƒ½

### ğŸ” è¯„ä¼°èƒ½åŠ›
- **çœŸå®RAGç»„ä»¶**: ä½¿ç”¨FinbertEncoderã€BilingualRetrieverã€QwenReranker
- **åŒè¯­è¨€æ”¯æŒ**: æ”¯æŒä¸­è‹±æ–‡æ··åˆæ£€ç´¢å’Œè¯„ä¼°
- **é‡æ’åºä¼˜åŒ–**: ä½¿ç”¨QwenRerankeræå‡æ£€ç´¢ç²¾åº¦
- **MRRè¯„ä¼°**: è®¡ç®—Mean Reciprocal RankæŒ‡æ ‡
- **å¤šGPUæ”¯æŒ**: æ”¯æŒå¤šGPUå¹¶è¡Œå¤„ç†
- **æ‰¹é‡å¤„ç†**: é«˜æ•ˆçš„æ‰¹é‡è¯„ä¼°æœºåˆ¶

### ğŸ—ï¸ ç³»ç»Ÿæ¶æ„

```
åŸå§‹è¯„ä¼°è„šæœ¬ (çœŸå®RAGç»„ä»¶ç‰ˆ)
â”œâ”€â”€ æ•°æ®åŠ è½½æ¨¡å—
â”‚   â”œâ”€â”€ è¯„ä¼°æ•°æ®åŠ è½½
â”‚   â”œâ”€â”€ æ£€ç´¢åº“æ„å»º (DocumentWithMetadata)
â”‚   â””â”€â”€ æ•°æ®é¢„å¤„ç†
â”œâ”€â”€ RAGç³»ç»Ÿç®¡ç†å™¨
â”‚   â”œâ”€â”€ FinbertEncoder (è‹±æ–‡)
â”‚   â”œâ”€â”€ FinbertEncoder (ä¸­æ–‡)
â”‚   â”œâ”€â”€ BilingualRetriever
â”‚   â”œâ”€â”€ QwenReranker
â”‚   â””â”€â”€ è®¾å¤‡ç®¡ç†
â”œâ”€â”€ æ£€ç´¢å¼•æ“æ¨¡å—
â”‚   â”œâ”€â”€ è¯­ä¹‰æ£€ç´¢ (BilingualRetriever)
â”‚   â”œâ”€â”€ è¯­è¨€æ£€æµ‹å’Œè·¯ç”±
â”‚   â””â”€â”€ æ–‡æ¡£æ’åº
â”œâ”€â”€ é‡æ’åºæ¨¡å—
â”‚   â”œâ”€â”€ å€™é€‰æ–‡æ¡£é‡æ’åº (QwenReranker)
â”‚   â”œâ”€â”€ ç›¸å…³æ€§è¯„åˆ†
â”‚   â””â”€â”€ æœ€ç»ˆæ’åº
â””â”€â”€ è¯„ä¼°åˆ†ææ¨¡å—
    â”œâ”€â”€ MRRè®¡ç®—
    â”œâ”€â”€ æ€§èƒ½ç»Ÿè®¡
    â””â”€â”€ ç»“æœè¾“å‡º
```

## ğŸš€ å¿«é€Ÿå¼€å§‹

### 1. åŸºç¡€ä½¿ç”¨ (TAT-QAæ•°æ®)

```bash
# ä½¿ç”¨TAT-QAè¯„ä¼°æ•°æ®
python encoder_finetune_evaluate/evaluate_encoder_reranker_mrr_rag_system_multi_gpu_fixed.py \
    --eval_data evaluate_mrr/tatqa_eval_enhanced.jsonl \
    --corpus_data evaluate_mrr/tatqa_train_qc_enhanced.jsonl \
    --max_samples 100
```

### 2. å®Œæ•´è¯„ä¼°

```bash
# å®Œæ•´è¯„ä¼°æ‰€æœ‰æ ·æœ¬
python encoder_finetune_evaluate/evaluate_encoder_reranker_mrr_rag_system_multi_gpu_fixed.py \
    --eval_jsonl evaluate_mrr/tatqa_eval_enhanced.jsonl \
    --corpus_jsonl evaluate_mrr/tatqa_knowledge_base.jsonl \
    --encoder_model_name "models/finetuned_finbert_tatqa" \
    --reranker_model_name "Qwen/Qwen3-Reranker-0.6B"
```

### 3. è‡ªå®šä¹‰å‚æ•°

```bash
# è‡ªå®šä¹‰æ£€ç´¢å’Œé‡æ’åºå‚æ•°
python encoder_finetune_evaluate/evaluate_encoder_reranker_mrr_rag_system_multi_gpu_fixed.py \
    --eval_jsonl evaluate_mrr/tatqa_eval_enhanced.jsonl \
    --corpus_jsonl evaluate_mrr/tatqa_knowledge_base.jsonl \
    --top_k_retrieval 200 \
    --top_k_rerank 20 \
    --batch_size 8 \
    --num_gpus 2
```

## ğŸ“Š å‚æ•°è¯´æ˜

### ğŸ”§ åŸºç¡€å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--eval_jsonl` | str | `evaluate_mrr/tatqa_eval_enhanced.jsonl` | è¯„ä¼°æ•°æ®æ–‡ä»¶è·¯å¾„ |
| `--corpus_jsonl` | str | `evaluate_mrr/tatqa_knowledge_base.jsonl` | æ£€ç´¢åº“æ•°æ®æ–‡ä»¶ |
| `--encoder_model_name` | str | `models/finetuned_finbert_tatqa` | ç¼–ç å™¨æ¨¡å‹åç§° |
| `--reranker_model_name` | str | `Qwen/Qwen3-Reranker-0.6B` | é‡æ’åºæ¨¡å‹åç§° |
| `--device` | str | `cuda` | è®¾å¤‡é€‰æ‹© (cuda/cpu) |

### ğŸ›ï¸ æ€§èƒ½å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--top_k_retrieval` | int | 100 | æ£€ç´¢è¿”å›çš„top-kæ–‡æ¡£æ•° |
| `--top_k_rerank` | int | 10 | é‡æ’åºçš„top-kæ–‡æ¡£æ•° |
| `--max_eval_samples` | int | None | æœ€å¤§è¯„ä¼°æ ·æœ¬æ•° (Noneè¡¨ç¤ºå…¨éƒ¨) |
| `--batch_size` | int | 32 | æ‰¹æ¬¡å¤§å° |
| `--num_gpus` | int | 2 | ä½¿ç”¨çš„GPUæ•°é‡ |

### ğŸ” é«˜çº§å‚æ•°

| å‚æ•° | ç±»å‹ | é»˜è®¤å€¼ | è¯´æ˜ |
|------|------|--------|------|
| `--save_results` | flag | False | æ˜¯å¦ä¿å­˜è¯¦ç»†ç»“æœ |
| `--output_file` | str | `evaluation_results.json` | ç»“æœä¿å­˜æ–‡ä»¶å |
| `--verbose` | flag | False | æ˜¯å¦æ˜¾ç¤ºè¯¦ç»†æ—¥å¿— |

## ğŸ“ˆ ä½¿ç”¨åœºæ™¯

### ğŸ§ª å¿«é€Ÿæµ‹è¯•

**ç›®æ ‡**: éªŒè¯è„šæœ¬æ˜¯å¦æ­£å¸¸å·¥ä½œ
```bash
python encoder_finetune_evaluate/evaluate_encoder_reranker_mrr_rag_system_multi_gpu_fixed.py \
    --eval_jsonl evaluate_mrr/tatqa_eval_enhanced.jsonl \
    --corpus_jsonl evaluate_mrr/tatqa_knowledge_base.jsonl \
    --max_eval_samples 50 \
    --batch_size 1
```

### ğŸ“Š æ ‡å‡†è¯„ä¼°

**ç›®æ ‡**: æ ‡å‡†æ€§èƒ½è¯„ä¼°
```bash
python encoder_finetune_evaluate/evaluate_encoder_reranker_mrr_rag_system_multi_gpu_fixed.py \
    --eval_jsonl evaluate_mrr/tatqa_eval_enhanced.jsonl \
    --corpus_jsonl evaluate_mrr/tatqa_knowledge_base.jsonl \
    --top_k_retrieval 100 \
    --top_k_rerank 10 \
    --batch_size 4
```

### ğŸ¯ é«˜ç²¾åº¦è¯„ä¼°

**ç›®æ ‡**: è¿½æ±‚æœ€é«˜æ£€ç´¢ç²¾åº¦
```bash
python encoder_finetune_evaluate/evaluate_encoder_reranker_mrr_rag_system_multi_gpu_fixed.py \
    --eval_jsonl evaluate_mrr/tatqa_eval_enhanced.jsonl \
    --corpus_jsonl evaluate_mrr/tatqa_knowledge_base.jsonl \
    --top_k_retrieval 500 \
    --top_k_rerank 50 \
    --batch_size 2 \
    --save_results
```

## ğŸ“Š è¾“å‡ºç»“æœ

### ğŸ“‹ æ§åˆ¶å°è¾“å‡º

```
ğŸš€ å¼€å§‹RAGç³»ç»Ÿè¯„ä¼°
ğŸ“Š é…ç½®ä¿¡æ¯:
  - è¯„ä¼°æ•°æ®: evaluate_mrr/tatqa_eval_enhanced.jsonl
  - æ£€ç´¢åº“æ•°æ®: evaluate_mrr/tatqa_knowledge_base.jsonl
  - ç¼–ç å™¨æ¨¡å‹: models/finetuned_finbert_tatqa
  - é‡æ’åºæ¨¡å‹: Qwen/Qwen3-Reranker-0.6B
  - è®¾å¤‡: cuda
  - æ£€ç´¢top-k: 100
  - é‡æ’åºtop-k: 10
  - æ‰¹æ¬¡å¤§å°: 4
  - GPUæ•°é‡: 2

ğŸ“ˆ æ•°æ®ç»Ÿè®¡:
  - è¯„ä¼°æ ·æœ¬æ•°: 1663
  - æ£€ç´¢åº“å¤§å°: 14883
  - å¹³å‡æŸ¥è¯¢é•¿åº¦: 45.2 tokens
  - å¹³å‡æ–‡æ¡£é•¿åº¦: 156.7 tokens

ğŸ” å¼€å§‹è¯„ä¼°...
è¿›åº¦: 100%|â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆ| 1663/1663 [02:34<00:00, 10.8it/s]

ğŸ“Š è¯„ä¼°ç»“æœ:
============================================================
æ£€ç´¢æ€§èƒ½:
  - MRR @100: 0.2345
  - å¹³å‡æ£€ç´¢æ—¶é—´: 0.045s
  - æœ‰æ•ˆæŸ¥è¯¢æ•°: 1589/1663

é‡æ’åºæ€§èƒ½:
  - MRR @10: 0.3456
  - å¹³å‡é‡æ’åºæ—¶é—´: 0.123s
  - æœ‰æ•ˆæŸ¥è¯¢æ•°: 1589/1663

æ€»ä½“æ€§èƒ½:
  - æ€»è¯„ä¼°æ—¶é—´: 154.2s
  - å¹³å‡æ¯æŸ¥è¯¢æ—¶é—´: 0.093s
  - æˆåŠŸç‡: 95.5%

ğŸ‰ è¯„ä¼°å®Œæˆï¼
```

### ğŸ“„ è¯¦ç»†ç»“æœæ–‡ä»¶

å¦‚æœå¯ç”¨`--save_results`ï¼Œä¼šç”Ÿæˆè¯¦ç»†çš„JSONç»“æœæ–‡ä»¶ï¼š

```json
{
  "config": {
    "eval_data": "evaluate_mrr/tatqa_eval_enhanced.jsonl",
    "corpus_data": "evaluate_mrr/tatqa_train_qc_enhanced.jsonl",
    "encoder_model": "microsoft/DialoGPT-medium",
    "reranker_model": "microsoft/DialoGPT-medium",
    "top_k_retrieval": 100,
    "top_k_rerank": 10,
    "batch_size": 4
  },
  "results": {
    "retrieval_mrr": 0.2345,
    "rerank_mrr": 0.3456,
    "avg_retrieval_time": 0.045,
    "avg_rerank_time": 0.123,
    "total_time": 154.2,
    "success_rate": 0.955
  },
  "detailed_results": [
    {
      "query_id": 0,
      "query": "What is the revenue?",
      "retrieval_rank": 5,
      "rerank_rank": 2,
      "retrieval_time": 0.042,
      "rerank_time": 0.118
    }
  ]
}
```

## ğŸ”§ æ•…éšœæ’é™¤

### ğŸš¨ å¸¸è§é—®é¢˜

**1. GPUå†…å­˜ä¸è¶³**
```bash
# è§£å†³æ–¹æ¡ˆï¼šå‡å°‘æ‰¹æ¬¡å¤§å°æˆ–ä½¿ç”¨CPU
python encoder_finetune_evaluate/evaluate_encoder_reranker_mrr_rag_system_multi_gpu_fixed.py \
    --eval_jsonl evaluate_mrr/tatqa_eval_enhanced.jsonl \
    --corpus_jsonl evaluate_mrr/tatqa_knowledge_base.jsonl \
    --batch_size 1 \
    --num_gpus 1
```

**2. æ¨¡å‹åŠ è½½å¤±è´¥**
```bash
# è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥æ¨¡å‹åç§°å’Œç½‘ç»œè¿æ¥
python encoder_finetune_evaluate/evaluate_encoder_reranker_mrr_rag_system_multi_gpu_fixed.py \
    --eval_data evaluate_mrr/tatqa_eval_enhanced.jsonl \
    --corpus_data evaluate_mrr/tatqa_train_qc_enhanced.jsonl \
    --encoder_model "bert-base-uncased" \
    --reranker_model "bert-base-uncased"
```

**3. æ•°æ®æ–‡ä»¶æ ¼å¼é”™è¯¯**
```bash
# è§£å†³æ–¹æ¡ˆï¼šæ£€æŸ¥æ•°æ®æ–‡ä»¶æ ¼å¼
head -5 evaluate_mrr/tatqa_eval_enhanced.jsonl
head -5 evaluate_mrr/tatqa_train_qc_enhanced.jsonl
```

### ğŸ” è°ƒè¯•æ¨¡å¼

```bash
# å¯ç”¨è¯¦ç»†æ—¥å¿—å’Œä¿å­˜ç»“æœ
python encoder_finetune_evaluate/evaluate_encoder_reranker_mrr_rag_system_multi_gpu_fixed.py \
    --eval_data evaluate_mrr/tatqa_eval_enhanced.jsonl \
    --corpus_data evaluate_mrr/tatqa_train_qc_enhanced.jsonl \
    --max_samples 10 \
    --batch_size 1 \
    --verbose \
    --save_results
```

## ğŸ“š æœ€ä½³å®è·µ

### ğŸ¯ è¯„ä¼°æµç¨‹å»ºè®®

1. **æ•°æ®å‡†å¤‡**
   - ç¡®ä¿è¯„ä¼°æ•°æ®å’Œæ£€ç´¢åº“æ•°æ®æ ¼å¼æ­£ç¡®
   - æ£€æŸ¥æ•°æ®è´¨é‡å’Œå®Œæ•´æ€§

2. **å‚æ•°è°ƒä¼˜**
   - ä»é»˜è®¤å‚æ•°å¼€å§‹
   - æ ¹æ®æ•°æ®ç‰¹ç‚¹è°ƒæ•´top_kå€¼
   - å¹³è¡¡ç²¾åº¦å’Œé€Ÿåº¦

3. **ç»“æœåˆ†æ**
   - ä¿å­˜è¯¦ç»†ç»“æœè¿›è¡Œåˆ†æ
   - å¯¹æ¯”ä¸åŒå‚æ•°é…ç½®çš„æ•ˆæœ

### âš¡ æ€§èƒ½ä¼˜åŒ–

1. **æ‰¹æ¬¡å¤§å°è°ƒä¼˜**
   - æ ¹æ®GPUå†…å­˜è°ƒæ•´batch_size
   - ä»1å¼€å§‹é€æ­¥å¢åŠ 

2. **æ¨¡å‹é€‰æ‹©**
   - é€‰æ‹©é€‚åˆæ•°æ®åŸŸçš„é¢„è®­ç»ƒæ¨¡å‹
   - è€ƒè™‘æ¨¡å‹å¤§å°å’Œæ€§èƒ½å¹³è¡¡

3. **æ£€ç´¢å‚æ•°ä¼˜åŒ–**
   - è°ƒæ•´top_k_retrievalå’Œtop_k_rerank
   - æ ¹æ®å®é™…éœ€æ±‚ä¼˜åŒ–

### ğŸ”’ æ•°æ®è´¨é‡

1. **æ•°æ®æ ¼å¼æ£€æŸ¥**
   - ç¡®ä¿JSONLæ ¼å¼æ­£ç¡®
   - æ£€æŸ¥å¿…è¦å­—æ®µå®Œæ•´æ€§

2. **æ•°æ®æ³„éœ²æ£€æŸ¥**
   - ç¡®ä¿è¯„ä¼°é›†å’Œè®­ç»ƒé›†åˆ†ç¦»
   - é¿å…æ•°æ®æ±¡æŸ“

## ğŸ“ æŠ€æœ¯æ”¯æŒ

å¦‚æœé‡åˆ°é—®é¢˜ï¼š
1. æ£€æŸ¥å‚æ•°é…ç½®å’Œæ•°æ®æ–‡ä»¶
2. æŸ¥çœ‹é”™è¯¯æ—¥å¿—å’Œè¯¦ç»†è¾“å‡º
3. å°è¯•ç®€åŒ–é…ç½®è¿›è¡Œè°ƒè¯•
4. è”ç³»æŠ€æœ¯æ”¯æŒ

---

**æ³¨æ„**: å»ºè®®ä»æœ€å°é…ç½®å¼€å§‹æµ‹è¯•ï¼Œç¡®ä¿ç³»ç»Ÿç¨³å®šè¿è¡Œåå†è¿›è¡Œå®Œæ•´è¯„ä¼°ã€‚ 